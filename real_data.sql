-- MySQL dump 10.13  Distrib 8.0.19, for Win64 (x86_64)
--
-- Host: localhost    Database: dev_ai
-- ------------------------------------------------------
-- Server version	11.8.5-MariaDB-ubu2404

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `attachments`
--

DROP TABLE IF EXISTS `attachments`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `attachments` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `message_id` bigint(20) unsigned NOT NULL,
  `filename` varchar(255) NOT NULL,
  `original_filename` varchar(255) NOT NULL,
  `mime_type` varchar(255) NOT NULL,
  `size` bigint(20) unsigned NOT NULL,
  `content` longtext DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `attachments_message_id_index` (`message_id`),
  CONSTRAINT `attachments_message_id_foreign` FOREIGN KEY (`message_id`) REFERENCES `messages` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `attachments`
--

LOCK TABLES `attachments` WRITE;
/*!40000 ALTER TABLE `attachments` DISABLE KEYS */;
INSERT INTO `attachments` VALUES (1,11,'attachments/1767072073_test_error.log','test_error.log','text/plain',386,'[2025-12-30 10:00:00] ERROR: SQLSTATE[HY000] [2002] Connection refused\n[2025-12-30 10:00:01] Stack trace:\n  #0 /var/www/html/vendor/laravel/framework/src/Illuminate/Database/Connectors/Connector.php(70): PDO->__construct()\n  #1 /var/www/html/vendor/laravel/framework/src/Illuminate/Database/Connectors/MySqlConnector.php(24): Illuminate\\Database\\Connectors\\Connector->createConnection()','2025-12-30 14:21:13','2025-12-30 14:21:13'),(2,19,'attachments/1767072604_conversation_3_20251228_202727.txt','conversation_3_20251228_202727.txt','text/plain',801,'Exce VBAのコード質問\n==============\n\n作成日時: 2025-12-28 20:25:59\nモード: 開発支援\n\n--------------------------------------------------------------------------------\n\n[ユーザー]\nExce VBAのコード質問\n\n--------------------------------------------------------------------------------\n\n[AI]\nExcel VBAのコードについて質問をどうぞ！\n\n以下のような内容でお答えできます：\n- エラーの原因特定と修正方法\n- 処理の最適化・高速化\n- 動作するサンプルコード\n- セル操作、ファイル処理、ループ処理など\n\n具体的なコードやエラーメッセージを貼り付けていただければ、より的確に回答できます。\n\n--------------------------------------------------------------------------------\n\n','2025-12-30 14:30:04','2025-12-30 14:30:04'),(3,21,'attachments/1767072644_chat_js_fixed.js','chat_js_fixed.js','text/plain',8656,'// ===== ファイルアップロード処理（修正版） =====\n\nasync function handleFileUpload(message, mode, conversationId, fileInput) {\n    const loadingId = appendMessage(\'assistant\', \'考え中...\', true);\n\n    try {\n        const formData = new FormData();\n        formData.append(\'message\', message);\n        formData.append(\'mode\', mode);\n        if (conversationId) {\n            formData.append(\'conversation_id\', conversationId);\n        }\n\n        // ファイルを追加\n        Array.from(fileInput.files).forEach(file => {\n            formData.append(\'files[]\', file);\n        });\n\n        console.log(\'Uploading files:\', Array.from(fileInput.files).map(f => f.name));\n\n        const response = await fetch(\'{{ route(\"chat.send\") }}\', {\n            method: \'POST\',\n            headers: {\n                \'X-CSRF-TOKEN\': csrfToken,\n                \'Accept\': \'application/json\',  // JSONレスポンスを期待\n            },\n            body: formData,\n        });\n\n        console.log(\'Response status:\', response.status);\n        console.log(\'Response content-type:\', response.headers.get(\'content-type\'));\n\n        // HTTPステータスチェック\n        if (!response.ok) {\n            const errorText = await response.text();\n            console.error(\'Server Error Response:\', errorText);\n            \n            // HTMLエラーページが返ってきた場合\n            if (errorText.includes(\'<!DOCTYPE\') || errorText.includes(\'<html\')) {\n                throw new Error(`サーバーエラー (${response.status}): ページが見つからないか、サーバー内部エラーが発生しました`);\n            }\n            \n            // JSONエラーレスポンスの場合\n            try {\n                const errorData = JSON.parse(errorText);\n                throw new Error(errorData.message || errorData.error || `HTTP ${response.status} エラー`);\n            } catch (parseError) {\n                throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);\n            }\n        }\n\n        // Content-Typeチェック\n        const contentType = response.headers.get(\'content-type\');\n        if (!contentType || !contentType.includes(\'application/json\')) {\n            const text = await response.text();\n            console.error(\'Non-JSON Response:\', text.substring(0, 500));\n            throw new Error(\'サーバーから正しいJSON応答が返されませんでした。HTMLページが返ってきています。\');\n        }\n\n        // JSONパース\n        const data = await response.json();\n        console.log(\'Response data:\', data);\n        \n        // ローディング表示を削除\n        document.getElementById(loadingId)?.remove();\n\n        if (data.success) {\n            appendMessage(\'assistant\', data.response);\n\n            // 新しい会話の場合、URLを更新\n            if (data.conversation_id && !conversationIdInput.value) {\n                conversationIdInput.value = data.conversation_id;\n                window.history.replaceState({}, \'\', `/chat?conversation=${data.conversation_id}`);\n                setTimeout(() => location.reload(), 1000);\n            }\n        } else {\n            appendMessage(\'error\', `エラー: ${data.error || \'不明なエラーが発生しました\'}`);\n        }\n        \n    } catch (error) {\n        document.getElementById(loadingId)?.remove();\n        console.error(\'Upload Error:\', error);\n        appendMessage(\'error\', `アップロードエラー: ${error.message}`);\n    }\n}\n\n// ===== 通常のテキスト送信（修正版） =====\n\nasync function handleNormalResponse(message, mode, conversationId) {\n    const loadingId = appendMessage(\'assistant\', \'考え中...\', true);\n\n    try {\n        const response = await fetch(\'{{ route(\"chat.send\") }}\', {\n            method: \'POST\',\n            headers: {\n                \'X-CSRF-TOKEN\': csrfToken,\n                \'Content-Type\': \'application/json\',\n                \'Accept\': \'application/json\',\n            },\n            body: JSON.stringify({\n                message: message,\n                mode: mode,\n                conversation_id: conversationId,\n            }),\n        });\n\n        console.log(\'Response status:\', response.status);\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            console.error(\'Server Error:\', errorText);\n            \n            if (errorText.includes(\'<!DOCTYPE\')) {\n                throw new Error(`サーバーエラー (${response.status})`);\n            }\n            \n            try {\n                const errorData = JSON.parse(errorText);\n                throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);\n            } catch (e) {\n                throw new Error(`HTTP ${response.status}: サーバーエラー`);\n            }\n        }\n\n        const contentType = response.headers.get(\'content-type\');\n        if (!contentType?.includes(\'application/json\')) {\n            const text = await response.text();\n            console.error(\'Non-JSON Response:\', text.substring(0, 500));\n            throw new Error(\'サーバーから正しい応答が返されませんでした\');\n        }\n\n        const data = await response.json();\n        document.getElementById(loadingId)?.remove();\n\n        if (data.success) {\n            appendMessage(\'assistant\', data.response);\n\n            if (data.conversation_id && !conversationIdInput.value) {\n                conversationIdInput.value = data.conversation_id;\n                window.history.replaceState({}, \'\', `/chat?conversation=${data.conversation_id}`);\n                setTimeout(() => location.reload(), 1000);\n            }\n        } else {\n            appendMessage(\'error\', `エラー: ${data.error}`);\n        }\n        \n    } catch (error) {\n        document.getElementById(loadingId)?.remove();\n        console.error(\'Request Error:\', error);\n        appendMessage(\'error\', `エラー: ${error.message}`);\n    }\n}\n\n// ===== ストリーミング応答（修正版） =====\n\nasync function handleStreamingResponse(message, mode, conversationId) {\n    const messageId = appendStreamingMessage();\n\n    try {\n        const response = await fetch(\'{{ route(\"chat.send.stream\") }}\', {\n            method: \'POST\',\n            headers: {\n                \'X-CSRF-TOKEN\': csrfToken,\n                \'Content-Type\': \'application/json\',\n                \'Accept\': \'text/event-stream\',\n            },\n            body: JSON.stringify({\n                message: message,\n                mode: mode,\n                conversation_id: conversationId,\n            }),\n        });\n\n        if (!response.ok) {\n            const errorText = await response.text();\n            console.error(\'Streaming Error:\', errorText);\n            throw new Error(`HTTP ${response.status}: ストリーミング接続に失敗しました`);\n        }\n\n        const reader = response.body.getReader();\n        const decoder = new TextDecoder();\n        let buffer = \'\';\n\n        while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n\n            buffer += decoder.decode(value, { stream: true });\n            const lines = buffer.split(\'\\n\');\n            buffer = lines.pop();\n\n            for (const line of lines) {\n                if (line.startsWith(\'data: \')) {\n                    try {\n                        const data = JSON.parse(line.slice(6));\n\n                        if (data.text) {\n                            appendTextToStreamingMessage(messageId, data.text);\n                        }\n\n                        if (data.done) {\n                            if (data.conversation_id && !conversationIdInput.value) {\n                                conversationIdInput.value = data.conversation_id;\n                                window.history.replaceState({}, \'\', `/chat?conversation=${data.conversation_id}`);\n                                setTimeout(() => location.reload(), 1000);\n                            }\n                        }\n\n                        if (data.error) {\n                            throw new Error(data.error);\n                        }\n                    } catch (parseError) {\n                        console.error(\'JSON Parse Error:\', parseError, \'Line:\', line);\n                    }\n                }\n            }\n        }\n\n        finalizeStreamingMessage(messageId);\n\n    } catch (error) {\n        console.error(\'Streaming Error:\', error);\n        document.getElementById(messageId)?.remove();\n        appendMessage(\'error\', `ストリーミングエラー: ${error.message}`);\n    }\n}\n','2025-12-30 14:30:44','2025-12-30 14:30:44'),(4,23,'attachments/1767073451_longtext.log','longtext.log','text/x-php',105,'<?php\r\n   $veryLongVariableName = \"ThisIsAVeryLongStringWithoutSpacesThisIsAVeryLongStringWithoutSpaces\";','2025-12-30 14:44:11','2025-12-30 14:44:11'),(5,25,'attachments/1767073538_test1230_error.log','test1230_error.log','text/plain',386,'[2025-12-30 10:00:00] ERROR: SQLSTATE[HY000] [2002] Connection refused\n[2025-12-30 10:00:01] Stack trace:\n  #0 /var/www/html/vendor/laravel/framework/src/Illuminate/Database/Connectors/Connector.php(70): PDO->__construct()\n  #1 /var/www/html/vendor/laravel/framework/src/Illuminate/Database/Connectors/MySqlConnector.php(24): Illuminate\\Database\\Connectors\\Connector->createConnection()','2025-12-30 14:45:38','2025-12-30 14:45:38');
/*!40000 ALTER TABLE `attachments` ENABLE KEYS */;
UNLOCK TABLES;
